@{
    ViewData["Title"] = "Kategorilere Göre Satış Raporu";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h3 class="mb-3">Kategorilere Göre Satış Raporu</h3>

<div class="row mb-3 p-3 border rounded bg-light">
    <div class="col-md-3">
        <label>Başlangıç Tarihi</label>
        <div id="startDateBox"></div>
    </div>
    <div class="col-md-3">
        <label>Bitiş Tarihi</label>
        <div id="endDateBox"></div>
    </div>
    <div class="col-md-2 d-flex align-items-end">
        <div id="filterButton"></div>
    </div>
</div>

<div id="categoryReportGrid"></div>

@section Scripts {
    <script>
        $(function () {
            // 1. Başlangıç Tarih Kutusu
            var startDate = $("#startDateBox").dxDateBox({
                type: "date",
                value: new Date(new Date().getFullYear(), new Date().getMonth(), 1), // Ayın ilk günü
                displayFormat: "dd.MM.yyyy"
            }).dxDateBox("instance");

            // 2. Bitiş Tarih Kutusu
            var endDate = $("#endDateBox").dxDateBox({
                type: "date",
                value: new Date(), // Bugün
                displayFormat: "dd.MM.yyyy"
            }).dxDateBox("instance");

            // 3. DataGrid Tanımlaması
            var gridInstance = $("#categoryReportGrid").dxDataGrid({
                dataSource: DevExpress.data.AspNet.createStore({
                    key: "categoryName", // DTO içindeki benzersiz alan (veya null değilse)
                    loadUrl: "/Category/GetCategoryReport",
                    onBeforeSend: function(method, ajaxOptions) {
                        // Dinamik olarak tarihleri her istekte ekle
                        ajaxOptions.data.startDate = startDate.option("value") ? startDate.option("value").toISOString() : null;
                        ajaxOptions.data.endDate = endDate.option("value") ? endDate.option("value").toISOString() : null;
                    }
                }),
                showBorders: true,
                rowAlternationEnabled: true,
                paging: { pageSize: 10 },
                searchPanel: { visible: true },
                columns: [
                    {
                        dataField: "categoryName",
                        caption: "Kategori Adı"
                    },
                    {
                        dataField: "totalQuantity",
                        caption: "Toplam Satış Adedi",
                        dataType: "number",
                        format: "#,##0"
                    },
                    {
                        dataField: "totalAmount",
                        caption: "Toplam Tutar",
                        dataType: "number",
                        format: {
                            type: "currency",
                            precision: 2
                        }
                    }
                ],
                summary: {
                    totalItems: [{
                        column: "totalAmount",
                        summaryType: "sum",
                        valueFormat: "currency",
                        displayFormat: "Genel Toplam: {0}"
                    }]
                }
            }).dxDataGrid("instance");

            // 4. Filtreleme Butonu
            $("#filterButton").dxButton({
                text: "Raporu Listele",
                type: "success",
                icon: "refresh",
                onClick: function() {
                    gridInstance.refresh(); // Sadece gridi yeniler, onBeforeSend tekrar çalışır
                }
            });
        });
    </script>
}